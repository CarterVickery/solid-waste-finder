"use strict";angular.module("solidWasteFinderApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.bootstrap","geolocation","angular-toArrayFilter"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("solidWasteFinderApp").controller("MainCtrl",["$scope","$http","$timeout","geolocation",function(a,b,c,d){var e,f,g,h;a.features=[];var i=null;a.userType={home:!0,business:!0},a.isResident=!0,a.isBusiness=!0;var j=function(a){var b=L.icon({iconUrl:"images/location.01de4869.png",iconSize:[14,14]});g.clearLayers(),g.addLayer(L.marker(a,{icon:b}))},k=function(a,b){return angular.forEach(b,function(b){var c=turf.distance(a,b,"miles");console.log(b.geometry.coordinates),console.log(c),b.properties.DISTANCE=c}),b},l=function(a,b){var c=turf.nearest(a,b),d=L.geoJson(a).getBounds();d=d.extend(L.geoJson(c).getBounds()),e.fitBounds([d],{padding:[100,100]}),h.clearLayers();var f=L.AwesomeMarkers.icon({icon:"trash",markerColor:"red"}),g=L.marker([c.geometry.coordinates[1],c.geometry.coordinates[0]],{icon:f,zIndexOffset:100}).bindPopup("<strong>"+c.properties.OPERATOR+"</strong><br/>"+c.properties.TYPE+"<br/>"+c.properties.ADDRESS+"<br/>"+c.properties.HOURS+"<strong><br/>"+c.properties.OPENTO+'<br/><a href="'+m(a.geometry.coordinates,c.geometry.coordinates)+'">Directions</a>');h.addLayer(g),g.openPopup()},m=function(a,b){return"https://www.google.com/maps/dir/"+a[1]+","+a[0]+"/"+b[1]+","+b[0]};a.getLocation=function(){a.geolocating=!0,d.getLocation().then(function(b){console.log(b),a.geolocating=!1,f={type:"Feature",properties:{},geometry:{type:"Point",coordinates:[b.coords.longitude,b.coords.latitude]}},j([b.coords.latitude,b.coords.longitude]),a.query(),i.bindPopup(function(a){return L.Util.template('<strong>{OPERATOR}</strong><br/>{TYPE}<br/>{ADDRESS}<br/>{HOURS}<strong><br/>{OPENTO}<br/><a href="'+m(f.geometry.coordinates,a.geometry.coordinates)+'">Directions</a>',a.properties)})})},a.query=function(){console.log("query");var b=[],c="";if(a.material){var d="'"+a.material.categories.toString().replace(/,/g,"','")+"'";b.push("CATEGORY IN ("+d+")")}a.userType.home&&a.userType.business||(a.userType.home?b.push("OPENTO IN ('Residents and Businesses', 'Residents only')"):a.userType.business&&b.push("OPENTO IN ('Residents and Businesses', 'Businesses only')")),c=0===b.length?"1=1":1===b.length?b[0]:b[0]+" AND "+b[1],i.query().where(c).run(function(b,c){f&&(l(f,c),a.features=k(f,c.features)),a.features=c.features,a.$$phase||a.$digest()}),i.setWhere(c)},a.filterByCategory=function(b){console.log("filter");var c=[];return a.isResident&&a.isBusiness?c=["Residents and Businesses","Residents only","Businesses only"]:a.userType.home?c=["Residents and Businesses","Residents only"]:a.userType.business&&(c=["Residents and Businesses","Businesses only"]),a.material&&c.length>0?a.material.categories.indexOf(b.feature.properties.CATEGORY)>-1&&c.indexOf(b.feature.properties.OPENTO)>-1:a.material?a.material.categories.indexOf(b.feature.properties.CATEGORY)>-1:c.length>0?c.indexOf(b.feature.properties.OPENTO)>-1:!0},a.userTypeChanged=function(){c(function(){a.query()})};var n=function(){e=L.map("map").setView([35.81889,-78.64447],10),L.esri.basemapLayer("Gray").addTo(e),i=L.esri.featureLayer("http://maps.wakegov.com/arcgis/rest/services/Environmental/SWFacilities/MapServer/0",{cacheLayers:!1,pointToLayer:function(a,b){var c=L.AwesomeMarkers.icon({icon:"trash",markerColor:"blue"});return L.marker(b,{icon:c})}}).addTo(e),i.bindPopup(function(a){return L.Util.template("<strong>{OPERATOR}</strong><br/>{TYPE}<br/>{ADDRESS}<br/>{HOURS}<strong><br/>{OPENTO}",a.properties)}),a.query(),g=L.featureGroup().addTo(e),h=L.featureGroup().addTo(e)},o=function(){b.get("data/materials.json").success(function(b){a.materials=b})};o(),n()}]),angular.module("solidWasteFinderApp").controller("AboutCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);